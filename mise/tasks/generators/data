#!/usr/bin/env bash
#MISE description="Process authoring data into generated/data"

set -euo pipefail

ROOT="$(pwd)"
SCHEMA="${ROOT}/data/schema.json"

PYTHON_BIN="${PYTHON_BIN:-python}"

"${PYTHON_BIN}" -m network_generators.generators.data --source "${ROOT}/data" --output "${ROOT}/generated/data"

JSONSCHEMA_BIN="${JSONSCHEMA_BIN:-jsonschema}"
if ! command -v "${JSONSCHEMA_BIN}" >/dev/null 2>&1; then
  ALT_BIN="/home/bc/.local/share/mise/installs/ubi-sourcemeta-jsonschema/11.10.0/jsonschema"
  if [ -x "${ALT_BIN}" ]; then
    JSONSCHEMA_BIN="${ALT_BIN}"
  else
    echo "jsonschema CLI not found. Set JSONSCHEMA_BIN or adjust PATH." >&2
    exit 1
  fi
fi

mapfile -t INSTANCES < <(find "${ROOT}/generated/data" -mindepth 2 -maxdepth 2 -name "*.json" | sort)

if [ "${#INSTANCES[@]}" -eq 0 ]; then
  echo "No processed JSON data files located under generated/data/*" >&2
  exit 1
fi

CMD=("${JSONSCHEMA_BIN}" "${SCHEMA}")
for instance in "${INSTANCES[@]}"; do
  CMD+=("--instance" "${instance}")
done

"${CMD[@]}"

echo "Validated ${#INSTANCES[@]} processed data file(s) against ${SCHEMA}"
